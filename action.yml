name: 'Find changed submodules'
description: 'Find out which submodule has changed'
outputs:
  repo_url:
    description: "URL of the changed submodule"
    value: ${{ steps.git-log.outputs.repo_url }}
  repo_name:
    description: "Name of the changed submodule"
    value: ${{ steps.git-log.outputs.repo_name }}
  repo_commit:
    description: "Commit of the changed submodule"
    value: ${{ steps.git-log.outputs.repo_commit }}
runs:
  using: "composite"
  steps: 
    - id: git-log
      shell: bash
      run: |
        REPO_NAME=$(git log --pretty=format: --name-only HEAD^.. | grep "^[^.]")
        echo "New package: ${REPO_NAME}"
        git submodule init ${REPO_NAME}
        REPO_URL=$(git config --list | grep "submodule.${REPO_NAME}.url=" | cut -d'=' -f2)
        REPO_COMMIT=$(git submodule status $REPO_NAME | awk '{print $1}' | sed 's/^[^0-9a-z]*//')
        echo ::set-output name=repo_url::$REPO_URL
        echo ::set-output name=repo_name::$REPO_NAME
        echo ::set-output name=repo_commit::$REPO_COMMIT
